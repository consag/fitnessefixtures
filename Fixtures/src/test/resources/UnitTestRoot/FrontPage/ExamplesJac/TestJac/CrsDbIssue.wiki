---
Test
---
!include -c <PowercenterDataintegration.PowercenterSettingUp


Vullen van de brontabellen gebeurt op deze pagina: http://oesv7008.rabobank.nl:9010/DatawarehouseDistribution.ZzzzSpeeltuin.TestFrankVanDenThillart.CrsOwnerOpa

This workflow:
 1 generates the CRS_ORCH_RUN_ID for the orchestrated run.
 1 derives the scenario for every record in OPA_KLANT and store it in table CRS_ORCH_OPA_KLANT_STI
 1 generates the logging records for every scenario to be run in this orchestrated run 

!define database {SR_ACT}
!define folder {CRS_ORCH}

|script           |Check fixture properties|
|for database name|${database}             |
|show             |login user              |
|show             |db connection           |


|get query result                                                             |
|database name|query                                           |get column ?  |
|${database}  |SELECT max(CRS_ORCH_RUN_ID) from CRS_ORCH_RUN_ID|$varRunIdPrev=|


Nu de echte workflows....

Deze workflow wordt gestart om er zeker van te zijn dat er minimaal 1 record in de tabel staat

|get query result                                                                        |
|database name|query                                             |get column ?           |
|${database}  |SELECT max(CRS_ORCH_RUN_ID)+1 from CRS_ORCH_RUN_ID|$varRunId=             |
|${database}  |SELECT TRUNC(SYSDATE) FROM DUAL                   |$varExpectedLoadDate=  |
|${database}  |SELECT MAX(RUN_ID) FROM SR_ACT_RUN_ID             |$varLastRunId_SR_ACT=  |
|${database}  |SELECT MAX(RUN_ID) FROM REL_CHK_RUN_ID            |$varLastRunId_REL_CHK= |
|${database}  |SELECT MAX(RUN_ID) FROM CRS_LTTR_RUN_ID           |$varLastRunId_CRS_LTTR=|


!define workflow {wf_CRS_ORCH_INIT_RUN}
!1 Test ${workflow}

'''Output workflow monitor'''

|table:select query                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|database name |SR_ACT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|sql statement |SELECT wfrun.workflow_name AS Workflow , tir.INSTANCE_NAME AS Sessie , stl.mapping_name AS Mapping , op.OBJECT_TYPE_NAME AS Soort , swl.INSTANCE_NAME AS Instance , swl.APPLIED_ROWS , swl.AFFECTED_ROWS , swl.REJECTED_ROWS , swl.THRUPUT , wfrun.server_net_name , wfrun.has_failed_tasks , wfrun.has_interrupts FROM OWNER_PG2.opb_wflow_run wfrun INNER JOIN OWNER_PG2.opb_subject subj ON subj.subj_id = wfrun.subject_id INNER JOIN OWNER_PG2.opb_task_inst_run tir ON wfrun.workflow_id = tir.workflow_id AND wfrun.workflow_run_id = tir.workflow_run_id LEFT OUTER JOIN OWNER_PG2.OPB_SESS_TASK_LOG stl ON wfrun.workflow_id = stl.workflow_id AND wfrun.workflow_run_id = stl.workflow_run_id AND tir.instance_id = stl.instance_id LEFT OUTER JOIN OWNER_PG2.OPB_SWIDGINST_LOG swl ON wfrun.workflow_id = swl.workflow_id AND wfrun.workflow_run_id = swl.workflow_run_id AND tir.instance_id = swl.task_instance_id INNER JOIN OWNER_PG2.OPB_OBJECT_TYPE op ON op.object_type = swl.widget_type WHERE op.OBJECT_TYPE_NAME NOT IN ('Start') AND wfrun.workflow_name = '${workflow}' AND op.OBJECT_TYPE_NAME IN ('Source Qualifier', 'Target Definition') AND wfrun.WORKFLOW_RUN_ID = ( SELECT MAX(WORKFLOW_RUN_ID) FROM OWNER_PG2.opb_wflow_run WHERE workflow_name = wfrun.workflow_name ) ORDER BY workflow_name , SESSIE , MAPPING , op.OBJECT_TYPE_NAME , swl.INSTANCE_NAME|
|correct values|WORKFLOW                                                                                                |SESSIE                                                                                                                            |MAPPING                                                                                                                         |SOORT                                                                                                         |INSTANCE                                                                                                                 |APPLIED_ROWS                                                                                            |AFFECTED_ROWS                                                                                            |REJECTED_ROWS                                                                                            |THRUPUT                                                                                            |SERVER_NET_NAME                                                                                            |HAS_FAILED_TASKS                                                                                            |HAS_INTERRUPTS                                                                                            |
|12            |${workflow}                                                                                             |s_m_CRS_ORCH_EXTRACT_AND_DERIVE_TA                                                                                                |m_CRS_ORCH_EXTRACT_AND_DERIVE_TA                                                                                                |Source Qualifier                                                                                              |SQ_OPA_KLANT                                                                                                             |2                                                                                                       |2                                                                                                        |0                                                                                                        |2                                                                                                  |CRM_01                                                                                                     |0                                                                                                           |0                                                                                                         |
|12            |${workflow}                                                                                             |s_m_CRS_ORCH_EXTRACT_AND_DERIVE_TA                                                                                                |m_CRS_ORCH_EXTRACT_AND_DERIVE_TA                                                                                                |Target Definition                                                                                             |CRS_ORCH_OPA_KLANT_STI                                                                                                   |2                                                                                                       |2                                                                                                        |0                                                                                                        |2                                                                                                  |CRM_01                                                                                                     |0                                                                                                           |0                                                                                                         |
|12            |${workflow}                                                                                             |s_m_CRS_ORCH_GENERATE_LOGGING_RECORDS                                                                                             |m_CRS_ORCH_GENERATE_LOGGING_RECORDS                                                                                             |Source Qualifier                                                                                              |SQ_CRS_ORCH_OPA_KLANT_STI                                                                                                |2                                                                                                       |2                                                                                                        |0                                                                                                        |2                                                                                                  |CRM_01                                                                                                     |0                                                                                                           |0                                                                                                         |
|12            |${workflow}                                                                                             |s_m_CRS_ORCH_GENERATE_LOGGING_RECORDS                                                                                             |m_CRS_ORCH_GENERATE_LOGGING_RECORDS                                                                                             |Source Qualifier                                                                                              |SQ_PWC_CRS_CT_PP_SCNRS                                                                                                   |4                                                                                                       |4                                                                                                        |0                                                                                                        |4                                                                                                  |CRM_01                                                                                                     |0                                                                                                           |0                                                                                                         |
|12            |${workflow}                                                                                             |s_m_CRS_ORCH_GENERATE_LOGGING_RECORDS                                                                                             |m_CRS_ORCH_GENERATE_LOGGING_RECORDS                                                                                             |Target Definition                                                                                             |CRS_ORCH_RUN                                                                                                             |4                                                                                                       |4                                                                                                        |0                                                                                                        |4                                                                                                  |CRM_01                                                                                                     |0                                                                                                           |0                                                                                                         |
|12            |${workflow}                                                                                             |s_m_CRS_ORCH_GENERATE_MISSING_RECORDS                                                                                             |m_CRS_ORCH_GENERATE_MISSING_RECORDS                                                                                             |Source Qualifier                                                                                              |SQ_CRS_ORCH_RUN_custom_SQL                                                                                               |2                                                                                                       |2                                                                                                        |0                                                                                                        |2                                                                                                  |CRM_01                                                                                                     |0                                                                                                           |0                                                                                                         |
|12            |${workflow}                                                                                             |s_m_CRS_ORCH_GENERATE_MISSING_RECORDS                                                                                             |m_CRS_ORCH_GENERATE_MISSING_RECORDS                                                                                             |Target Definition                                                                                             |CRS_ORCH_RUN                                                                                                             |2                                                                                                       |2                                                                                                        |0                                                                                                        |2                                                                                                  |CRM_01                                                                                                     |0                                                                                                           |0                                                                                                         |
|12            |${workflow}                                                                                             |s_m_CRS_ORCH_IGNORE_RECORDS                                                                                                       |m_CRS_ORCH_IGNORE_RECORDS                                                                                                       |Source Qualifier                                                                                              |SQ_CRS_ORCH_OPA_KLANT_STI                                                                                                |2                                                                                                       |2                                                                                                        |0                                                                                                        |2                                                                                                  |CRM_01                                                                                                     |0                                                                                                           |0                                                                                                         |
|12            |${workflow}                                                                                             |s_m_CRS_ORCH_IGNORE_RECORDS                                                                                                       |m_CRS_ORCH_IGNORE_RECORDS                                                                                                       |Target Definition                                                                                             |CRS_ORCH_OPA_KLANT_STI1                                                                                                  |2                                                                                                       |2                                                                                                        |0                                                                                                        |2                                                                                                  |CRM_01                                                                                                     |0                                                                                                           |0                                                                                                         |
|12            |${workflow}                                                                                             |s_m_CRS_ORCH_RUN_ID                                                                                                               |m_CRS_ORCH_RUN_ID                                                                                                               |Source Qualifier                                                                                              |SQ_CRS_ORCH_RUN_ID_custom_sql                                                                                            |1                                                                                                       |1                                                                                                        |0                                                                                                        |1                                                                                                  |CRM_01                                                                                                     |0                                                                                                           |0                                                                                                         |
|12            |${workflow}                                                                                             |s_m_CRS_ORCH_RUN_ID                                                                                                               |m_CRS_ORCH_RUN_ID                                                                                                               |Target Definition                                                                                             |CRS_ORCH_RUN_ID                                                                                                          |1                                                                                                       |1                                                                                                        |0                                                                                                        |1                                                                                                  |CRM_01                                                                                                     |0                                                                                                           |0                                                                                                         |

'''Target tables'''

|table:select query                                                                                                                                                  |
|database name |${database}                                                                                                                                          |
|sql statement |SELECT CRS_ORCH_RUN_ID, TRUNC(LOAD_DTTM) as LOAD_DTTM from CRS_ORCH_RUN_ID WHERE CRS_ORCH_RUN_ID = (SELECT max(CRS_ORCH_RUN_ID) from CRS_ORCH_RUN_ID)|
|correct values|CRS_ORCH_RUN_ID                                                         |LOAD_DTTM                                                                   |
|2             |$varRunId                                                               |$varExpectedLoadDate                                                        |

|table:select query                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|database name |${database}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|sql statement |SELECT CRS_ORCH_RUN_ID, PP_SCENARIO, ID, REL_ID, FK_ORG_REL_ID, FK_NP_REL_ID, KLANT_TYPE, BANK_CODE, CRS_TTS_STATUS, CRS_TTS_RESULT, CRS_TTS_INDICIA, CRS_LTR_COUNTRY_NAME, CRS_LTR_INDICIA, DONE, IGNORED, CRS_ORCH_RUN_ID_DONE FROM crs_orch_opa_klant_sti ORDER BY CRS_ORCH_RUN_ID, REQUESTOR_ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|correct values|CRS_ORCH_RUN_ID|PP_SCENARIO|ID|REL_ID|FK_ORG_REL_ID  |FK_NP_REL_ID|KLANT_TYPE|BANK_CODE|CRS_TTS_STATUS                                    |CRS_TTS_RESULT                                    |CRS_TTS_INDICIA                                                                                                                                                                                                                                                                                                                                                                                                                                                   |CRS_LTR_COUNTRY_NAME                              |CRS_LTR_INDICIA                                                                                                                                                                                                                                                                                                                                                                                                                                                   |DONE|IGNORED|CRS_ORCH_RUN_ID_DONE|
|18            |$varRunIdPrev  |99         |  |1     |ÎD3xxxxxxxxxxxx|1           |1         |5        |Téxt7xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|Téxt8xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|Téxt9xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|Téxt10xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|Téxt11xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|N   |Y      |$varRunId           |
|18            |$varRunIdPrev  |100        |  |1     |ÎD3xxxxxxxxxxxx|1           |1         |5        |Téxt7xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|Téxt8xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|Téxt9xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|Téxt10xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|Téxt11xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|N   |Y      |$varRunId           |
|18            |$varRunId      |99         |  |1     |ÎD3xxxxxxxxxxxx|1           |1         |5        |Téxt7xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|Téxt8xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|Téxt9xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|Téxt10xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|Téxt11xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|N   |N      |                    |
|18            |$varRunId      |100        |  |1     |ÎD3xxxxxxxxxxxx|1           |1         |5        |Téxt7xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|Téxt8xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|Téxt9xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|Téxt10xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|Téxt11xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|N   |N      |                    |

|table:select query                                                                                                                                                  |
|database name |${database}                                                                                                                                          |
|sql statement |SELECT CRS_ORCH_RUN_ID, PP_SCENARIO, UPLOAD_APPLICATION, INDEXNBR, LAST_RUN_ID,DONE FROM CRS_ORCH_RUN ORDER BY CRS_ORCH_RUN_ID, PP_SCENARIO, INDEXNBR|
|correct values|CRS_ORCH_RUN_ID           |PP_SCENARIO           |UPLOAD_APPLICATION           |INDEXNBR           |LAST_RUN_ID                      |DONE           |
|5             |$varRunId                 |99                    |SR_ACT                       |1                  |-1                               |N              |
|5             |$varRunId                 |99                    |REL_CHK                      |2                  |$varLastRunId_REL_CHK            |N              |
|5             |$varRunId                 |99                    |CRS_LTTR                     |3                  |-1                               |N              |
|5             |$varRunId                 |100                   |SR_ACT                       |1                  |$varLastRunId_SR_ACT             |N              |
|5             |$varRunId                 |100                   |REL_CHK                      |2                  |$varLastRunId_REL_CHK            |N              |
|5             |$varRunId                 |100                   |CRS_LTTR                     |3                  |$varLastRunId_CRS_LTTR           |N              |



